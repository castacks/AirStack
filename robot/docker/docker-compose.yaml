# desktop build
services:
  # ===================================================================================================================
  # for developing locally on a single machine
  # note, this service name is currently used as the name of the robot
  robot:
    profiles:
      - ""
      - sitl
    extends:
      file: ./robot-base-docker-compose.yaml
      service: robot_base
    image: &desktop_image ${PROJECT_DOCKER_REGISTRY}/${PROJECT_NAME}:v${DOCKER_IMAGE_TAG}_robot-x86-64
    build:
      dockerfile: ./Dockerfile.robot
      args:
        BASE_IMAGE: ubuntu:22.04
      tags:
        - *desktop_image
    # we use tmux send-keys so that the session stays alive
    command: >
      bash -c "service ssh restart;
      tmux new -d -s robot_bringup
      && tmux send-keys -t robot_bringup 
      'bws && sws && 
      ros2 launch ${ROBOT_MAIN_LAUNCH}' ENTER
      && sleep infinity"
    # assumes you're connected to work internet, so creates a network to isolate from other developers on your work internet
    networks:
      - airstack_network
    # allow scaling multiple robots on the same machine
    ports:
      # for ssh, starting from 2223-2243 on the host port all map to 22 in the container. Assumes no more than 21 robots
      - "2223-2243:22"

  # -------------------------------------------------------------------------------------------------------------------
  # dev container for developer debugging
  robot-dev:
    profiles: !override
      - "dev"
    extends: robot
    command: sleep infinity

  # ===================================================================================================================
  # for running on an NVIIDA jetson (linux for tegra) device
  robot-l4t:
    profiles:
      - hitl
      - deploy
    extends:
      file: ./robot-base-docker-compose.yaml
      service: robot_base
    image: &l4t_image ${PROJECT_DOCKER_REGISTRY}/${PROJECT_NAME}:v${DOCKER_IMAGE_TAG}_robot-l4t
    build:
      dockerfile: ./Dockerfile.robot
      args:
        BASE_IMAGE: nvcr.io/nvidia/l4t-jetpack:r36.4.0
        REAL_ROBOT: true
      tags:
        - *l4t_image
    # we use tmux send-keys so that the session stays alive
    ipc: host
    command: >
      bash -c "ssh service restart;
      tmux new -d -s robot_bringup
      && tmux send-keys -t robot_bringup 
      'bws && sws && 
      DATE=$(date | sed \"s/ /_/g\" | sed \"s/:/_/g\") ros2 launch robot_bringup robot.launch.xml sim:="false" ' ENTER
      && sleep infinity"
    runtime: nvidia
    # assumes network isolation via a physical router, so uses network_mode=host
    network_mode: host
    volumes:
      - /media/airlab/Storage/airstack_collection:/bags:rw

  ros1_bridge:
    image: ros1_bridge
    # profiles:
    #   - ipp
    build:
      context: .
      dockerfile: ./rosbridge.Dockerfile
      args:
        ADD_example_custom_msgs: 1
    # command: >
    #   bash -c "
    #     echo 'export FASTRTPS_DEFAULT_PROFILES_FILE=/root/fastdds.xml' >> ~/.bashrc && \
    #     export FASTRTPS_DEFAULT_PROFILES_FILE=/root/fastdds.xml && \
    #     while true; do sleep 30; done
    #   "
    environment:
      - ACCEPT_EULA=Y
      - DISPLAY
      - QT_X11_NO_MITSHM=1
    deploy:
      # let it use the GPU
      resources:
        reservations:
          devices:
            - driver: nvidia # https://stackoverflow.com/a/70761193
              count: 1
              capabilities: [ gpu ]   
    volumes:
      # display stuff
      - $HOME/.Xauthority:/root/.Xauthority
      - /tmp/.X11-unix:/tmp/.X11-unix
      - .bashrc:/root/.bashrc:rw # bash config
      - /var/run/docker.sock:/var/run/docker.sock # access docker API for container name
      # developer stuff
      # - /var/run/docker.sock:/var/run/docker.sock # access docker API for container name    
      # - ./bridge.param:/root/ros1_bridge/bridge.param
      # - ./domain_bridge.yaml:/root/ros1_bridge/domain_bridge.yaml
    # runtime: nvidia
    privileged: true
    stdin_open: true
    tty: true
    networks:
      - airstack_network
